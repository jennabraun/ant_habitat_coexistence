---
title: Ants species coexistence
output:
    rmdformats::readthedown:
      collapsed: false
      highlight: kate
---

```{r setup}
library(dplyr)
library(tidyr)
library(ggplot2)
library(performance)
library(glmmTMB)
library(ade4)
library(nlme)
library(ape)
library(vegan)

wide <- read.csv("Clean Data/ants_wide.csv")
cov <- read.csv("Clean Data/ants.csv")
sites <- read.csv("Clean Data/sites_joined.csv")
cov <- right_join(sites, cov, by = c("Site", "month"))

cov <- dplyr::select(cov, 3:10, 14:19, 22:36, 39:41)

sum(cov$abun)
#add ecostress sensor data
eco <- read.csv("Clean Data/ecostress.csv")
eco <- select(eco, 1, 2, 11)
eco <- rename(eco, month = Category, Site = ID, esi = ECO4ESIPTJPL_001_Evaporative_Stress_Index_PT_JPL_ESIavg)
cov <- right_join(eco, cov, by = c("Site", "month"))

shrubs <- read.csv("Clean Data/shrubs.csv")
cov <- right_join(cov, shrubs, by = "Site")
cov$shrub.site <- as.factor(cov$shrub.site)

```




```{r}
traits <- read.csv("raw data/Traits.csv")

unique(traits$Trait)
#I don't trust the eye width measurements because they were from the front
traits <- filter(traits, Trait != "Eye width")
unique(traits$Photo)
traits <- separate(traits, Photo, c("Site", "Slide", "Specimen"))
traits$Site <- gsub("Papl", "PaPl", traits$Site)
unique(traits$Site)
traits <- traits[-1,]

#remove the double pheidole entry
traits <- traits[-2,]

#need to divide the trait values by weber's body length. I want to do this at the individual level
traits <- select(traits, -X, -Label)
traits <- pivot_wider(traits, names_from = Trait, values_from = Measure)
traits <- mutate(traits, Femur.w = Femur/Webers, Scape.w = Scape/Webers, Mandible.w = `Mandible length`/Webers, Headl.w = `Head length`/Webers, Eyel.w = `Eye length`/Webers, Headw.w = `Head width`/Webers)
traits <- pivot_longer(traits, 5:17, names_to = "Trait", values_to = "Measure")

unique(traits$X.1)


#some traits are NA because of damage to the specimen
traits <- drop_na(traits)

#calculate the mean value of the trait for each species at each site
traits.ag <- group_by(traits, Site, X.1, Trait) %>%
  summarise(mean = mean(Measure), sd = sd(Measure))

#create a data frame of the mean values for each species across all sites
traits.sp <- group_by(traits, X.1, Trait) %>% 
  summarise(mean = mean(Measure), sd = sd(Measure))


#calculate CWM trait values

#I want to do abundance
#it's proportional abundances 

site.j <- select(cov, uniID, Site)
wide <- right_join(site.j, wide, by = "uniID")

wide <- select(wide, -X)
#remove the two other solenopsis species with 1 individual
wide <- select(wide, -12, -13)
#wide <- rename(wide, Site = Site.x) %>%
  #select(-Site.y)

long <- pivot_longer(wide, 3:13, names_to = "species", values_to = "count")
#get total abundance per trap
long <- group_by(long, uniID) %>% 
  mutate(total = sum(count)) 

long <- long %>% mutate(rel.abun = count/total)

traits.ag <- rename(traits.ag, species = X.1)
traits.ag$species <- gsub(" ", "", traits.ag$species)

#this adds NA traits to 0 abundances - species isn't found at pitfall or site
join.right <- right_join(traits.ag, long, by = c("Site", "species"))

#join.left <- left_join(traits.ag, long, by = c("Site", "species"))

CWM <- mutate(join.right, cwm.prod = mean*rel.abun)

CWM <- group_by(CWM, Site, uniID, Trait) %>% summarise(cwm = sum(cwm.prod))

#can log transform the abundances to look at dominants vs subordinates



#join environmental data to CWM trait dataframe

CWM <- left_join(CWM, cov, by = "uniID")


```

## CWM - Presence/absence

```{r}
long.pres <- pivot_longer(wide, 3:13, names_to = "species", values_to = "count")

long.pres <- mutate(long.pres, count.bin = ifelse(count >= 1, 1, 0))

#get total abundance per trap
long.pres <- group_by(long.pres, uniID) %>% 
  mutate(total = sum(count.bin)) 

long.pres <- long.pres %>% mutate(rel.abun = count.bin/total)

#traits.ag <- rename(traits.ag, species = X.1)
#traits.ag$species <- gsub(" ", "", traits.ag$species)

#this adds NA traits to 0 abundances - species isn't found at pitfall or site
join.right <- right_join(traits.ag, long.pres, by = c("Site", "species"))

#join.left <- left_join(traits.ag, long, by = c("Site", "species"))

CWM.pres <- mutate(join.right, cwm.prod = mean*rel.abun)

CWM.pres <- group_by(CWM.pres, Site, uniID, Trait) %>% summarise(cwm = sum(cwm.prod))

#can log transform the abundances to look at dominants vs subordinates

#join environmental data to CWM trait dataframe

CWM.pres <- left_join(CWM.pres, cov, by = "uniID")

```



# EDA

## Community Weighted Mean Trait * Sites

```{r}
CWM <- rename(CWM, Site = Site.x)

```

## Heat Map

```{r}

mat <- pivot_wider(CWM, names_from = Trait, values_from = cwm)
mat <- select(mat, 5:11, 14:17, 25:31, 36:48) %>% ungroup()
mat <- ungroup(mat) %>% select(-uniID)
mat <- drop_na(mat)
#str(mat)
M <- cor(mat)
corrplot::corrplot(M, method = "number")
```

# PCA 

## Traits

```{r}
# I want the PCA on traits
# make it wide again

traits.wide <- pivot_wider(traits, names_from = Trait, values_from = Measure)
traits.wide <- select(traits.wide, 11:17)
traits.wide <- drop_na(traits.wide)

library(vegan)
library(ggvegan)
traits.pca <- rda(traits.wide)
#summary(traits.pca)
#no scaling because the traits all have the same units
autoplot(traits.pca, xlab = "PCA 82.8%", ylab = "PCA 10.5%")


```

## Sites

```{r}
library(vegan)
env <- select(cov, 3:9, 12:15, 23:27, 29) %>% drop_na()
env.labels <- select(cov, 1:2)
options(scipen = 999)
env.pca <- rda(env, scaling = TRUE)
#summary(env.pca)
autoplot(env.pca)
#doesn't look good

#standardize to mean of zero etc
#not sure if correct
env.d <- decostand(env, method = "standardize")
env.pca <- rda(env.d)
    
#summary(env.pca)
autoplot(env.pca, xlab = "PCA 31.4%", ylab = "PCA 20.3%")

```
Cool that water stress is correlated with variability in vegetation

# ITV

Intraspecific trait variation

## Body size
```{r}

itv <- data.frame()

#body size
webers <- traits %>% filter(Trait == "Webers")
partition <- aov(Measure~X.1, data = webers)
summary(partition)



#ITV is a low component of overall variability

logWebers <- log(webers$Measure)
modPart <- lme(logWebers ~ 1, random = ~ 1 | Site / X.1, data = webers, na.action = na.omit)
varcompWeber <- ape::varcomp(modPart, scale = 1)
varcompWeber

#body size differences between individuals of the same species within a site account for 9.2% variation
#differences among species within a site account for 90.7%
#differences among species between sites accounts for 0 %
```

## Femur length

```{r}
# relative leg length
femur <- traits %>% filter(Trait == "Femur.w")
partition <- aov(Measure~X.1, data = femur)
summary(partition)

#ITV is 1.208/3.298 = 36.6% of variation

logFemur <- log(femur$Measure)
modPart <- lme(logFemur ~ 1, random = ~ 1 | Site / X.1, data = femur, na.action = na.omit)
varcompFemur <- ape::varcomp(modPart, scale = 1)
varcompFemur

#relative femur length differences between individuals of the same species within a site account for 31% variation
#differences among species within a site account for 66.7%
#differences among species between sites accounts for 2.4 %
```

## Scape length

```{r}
#scape length

scape <- traits %>% filter(Trait == "Scape.w")
partition <- aov(Measure~X.1, data = scape)
summary(partition)

#ITV is 0.706/4.632 = 15.2 % of variation

logScape <- log(scape$Measure)
modPart <- lme(logScape ~ 1, random = ~ 1 | Site / X.1, data = scape, na.action = na.omit)
varcompScape <- ape::varcomp(modPart, scale = 1)
varcompScape

#relative scape length differences between individuals of the same species within a site account for 15% variation
#differences among species within a site account for 84.5%
#differences among species between sites accounts for 0%
```

## Mandible length

```{r}
#mandible length

mandible <- traits %>% filter(Trait == "Mandible.w")
partition <- aov(Measure~X.1, data = mandible)
summary(partition)

#ITV is 0.3478/0.76 = 45.7 % of variation

logMandible <- log(mandible$Measure)
modPart <- lme(logMandible ~ 1, random = ~ 1 | Site / X.1, data = mandible, na.action = na.omit)
varcompMandible <- ape::varcomp(modPart, scale = 1)
varcompMandible

#relative mandible length differences between individuals of the same species within a site account for 36.6% variation
#differences among species within a site account for 63%
#differences among species between sites accounts for 0%
```

## Eye length

```{r}

#eye length

el <- traits %>% filter(Trait == "Eyel.w")
partition <- aov(Measure~X.1, data = el)
summary(partition)

#ITV is 0.06/0.31 = 21 % of variation

logEL <- log(el$Measure)
modPart <- lme(logEL ~ 1, random = ~ 1 | Site / X.1, data = el, na.action = na.omit)
varcompEL <- ape::varcomp(modPart, scale = 1)
varcompEL

#relative eye length differences between individuals of the same species within a site account for 24% variation
#differences among species within a site account for 75.9%
#differences among species between sites accounts for 0%
```

## Head width


```{r}
#head width

hw <- traits %>% filter(Trait == "Headw.w")
partition <- aov(Measure~X.1, data = hw)
summary(partition)

#ITV is 26%
0.49/(0.49+1.39)

logHW <- log(hw$Measure)
modPart <- lme(logHW ~ 1, random = ~ 1 | Site / X.1, data = hw, na.action = na.omit)
varcompHW <- ape::varcomp(modPart, scale = 1)
varcompHW

#relative head width differences between individuals of the same species within a site account for 21.8% variation
#differences among species within a site account for 78.1%
#differences among species between sites accounts for 0%


hl <- traits %>% filter(Trait == "Headl.w")
partition <- aov(Measure~X.1, data = hl)
summary(partition)



```
# Turnover vs ITV

Community mean trait values can shift along gradients due to differences in the species composition at the sites, and also due to intraspecific variation

Compare shifts in CWM measured along a gradient using site-specific trait values to global trait values





# Fourth Corner
## 4th Corner bivariate correlations
```{r}

#We need to set up our data


spe <- wide

#for traits species should be rows, traits cols
traits.spe <- select(traits.sp, -sd)
traits.spe <- pivot_wider(traits.spe, names_from = Trait, values_from = mean)

#only keep corrected traits (divided by body length)
#only keep one head trait (keeping width)

traits.spe <- select(traits.spe, 1, 3,5, 9, 11, 13, 14)
traits.spe <- rename(traits.spe, species = X.1)
row.names(traits.spe) <- traits.spe$species
traits.spe <- as.data.frame(traits.spe) %>% ungroup()
traits.spe <- select(traits.spe, -species)
#I want veg height but there are NAs ugh

env4 <- select(cov, uniID, 2, 3, 4, 5,12, 13,15,  17, 23, 29, 34)
env4$Microsite <- as.factor(env4$Microsite)

naveg <- env4[is.na(env4$veg..height),]

#make a vector of NA values
naveg <- naveg$uniID
`%!in%` <- Negate(`%in%`)

#remove those NA rows from the species table
spe <- spe[spe$uniID %!in% naveg, ]
env4 <- env4[env4$uniID %!in% naveg, ]

row.names(env4) <- env4$uniID
env4 <- env4[,-1]

row.names(spe) <- spe$uniID
spe <- select(spe, -1, -2)


spe.bin <- spe
spe.bin[spe.bin > 1] <- 1
```

## NMDS

```{r}

#get rid of zero rows in species data and also in environmental data
zero <- filter(spe.bin,rowSums(spe.bin)!=0)
zeroID <- row.names(zero)
zeroenv <- cov[cov$uniID %in% zeroID, ]
envz <- select(zeroenv,2,  3:9, 12, 15, 17, 23, 29, 34)
#wow so many zeros?

#nm <- metaMDS(zero)

#envfit(nm ~ esi +mean.cover + dry.veg.percent + shrub.site + Microsite + var.cover + veg..height + mean.height + Temp,envz, strata = envz$Site, perm = 999)


# m1 <- cca(zero ~ esi +mean.cover + dry.veg.percent + shrub.site + Microsite + var.cover + veg..height + mean.height + Temp + Site,envz, perm = 999)
# summary(m1)
# anova.cca(m1, by = "margin")
```

## CWM-NMDS
```{r}

cwm.comm <- select(CWM.pres, 2:4)
cwm.comm <- pivot_wider(cwm.comm, names_from = Trait, values_from = cwm)
cwm.comm <- select(cwm.comm, 3,5, 8,9,11, 13, 14)
row.names(cwm.comm) <- cwm.comm$uniID

cwm.comm <- drop_na(cwm.comm)
#hmm why is it 525 though?
#525 because of the missing data in veg height 

cwm.zero <- cwm.comm$uniID

#the NAs must be the zero rows


cwm.comm <- ungroup(cwm.comm) %>% select(-uniID)

cwm.env <- select(cov, 1, 2:9, 12, 15, 17, 23, 13, 31, 34)
cwm.env <- cwm.env[cwm.env$uniID %in% cwm.zero, ]
cwm.env <- select(cwm.env, -uniID)
nm.cwm <- metaMDS(cwm.comm)

#m1 <- envfit(nm.cwm ~  esi +mean.cover + dry.veg.percent + shrub.site + Microsite + var.cover + mean.height + Temp, cwm.env, permutations = 9999, strata = cwm.env$Site, na.rm = TRUE)
m1

plot(nm)
ordiplot(m1)


rdaNEspain.all <- rda(cwm.comm ~ esi +mean.cover + dry.veg.percent + shrub.site + Microsite + var.cover + mean.height + Temp, data = cwm.env, permutations = 9999, strata = cwm.env$Site)
plot(rdaNEspain.all, type = "n", scaling = "sites")
text(rdaNEspain.all, dis = "cn", scaling = "sites")
text(rdaNEspain.all, dis = "sp", scaling = "sites", col = "red")
anova.cca(rdaNEspain.all)
anova.cca(rdaNEspain.all, by = "terms")
anova.cca(rdaNEspain.all, by = "margin")
anova.cca(rdaNEspain.all, by = "axis")
rdaNEspain.all
#RDA does not explain much variation at all
#maybe stick with the nmds then?
```
db-RDA


```{r}

m2 <- capscale(zero~ arid + esi +mean.cover + dry.veg.percent + shrub.site + Microsite + var.cover + mean.height + Temp + Condition(Site), data = envz, dist = "bray")

m2
summary(m2)
anova.cca(m2, by = "margin", model = "reduced", strata = envz$Site)



m0  <- capscale(cwm.comm ~ 1+ Condition(Site), data = cwm.env, dist = "bray")



m1 <- capscale(cwm.comm ~ Prec + esi +mean.cover +dry.veg.percent+  + month+ Condition(Site), data = cwm.env, dist = "bray")


m1 <- capscale(cwm.comm ~ arid + esi  +mean.cover +dry.veg.percent+  Microsite  + Condition(Site), data = cwm.env, dist = "bray")

RsquareAdj(m1)$r.squared
m1
plot.cca(m1)


cor.test(cwm.env$esi, cwm.env$arid)
plot(cwm.env$esi, cwm.env$arid)

ggplot(cwm.env, aes(esi, arid)) + geom_smooth()

plot(m1, type = "n", scaling = "sites")
text(m1, dis = "cn", scaling = "sites")
text(m1, dis = "sp", scaling = "sites", col = "red")

autoplot(m1, scaling = 1)

summary(m1)
anova(m1)
anova.cca(m1, by = "terms", strata = cwm.env$Site)
anova.cca(m1, by = "margin", strata = cwm.env$Site)
anova.cca(m1, by = "axis", strata = cwm.env$Site)
ordiplot(m1)
arrows(m1, "species")
pl <- ordiplot(m1, type = "none")
points(pl, "sites", pch=21, col="red", bg="yellow")
text(pl, "species", col="blue", cex=0.9, arrows = TRUE)
arrows(p1, "sites")

```

```{r}

env4$Site <- as.factor(env4$Site)
evn4C <- select(env4, 2, 3, 7, 8, 9, 11)
#evn4C <- select(env4, 2:11)
#evn4C <- select(evn4C, 1, 3)


#shrub and open are really close
#gotta add shrub type

library(mvabund)
fit <- traitglm(spe.bin, evn4C, traits.spe, family = "binomial", method = "manyglm")
fit$fourth #notice LASSO penalty has shrunk many interactions to zero

#summary(fit, blcok = env4)

anova(fit, block = env4$Site, resamp = "case", nBoot = 99)
#signficant trait*env but takes 36 minutes to run

library(lattice)
a        = max( abs(fit$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
plot.4th = levelplot(t(as.matrix(fit$fourth.corner)), xlab="Environmental Variables",
 ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
 scales = list( x= list(rot = 45)))
print(plot.4th)

library(jtools)
summ(fit)
#test again for presence/absence
#ant abundance may be more related to colony size which is a trait




four.comb.ants.adj <- fourthcorner(env4, spe.bin,
traits.spe, modeltype = 6, p.adjust.method.G = "none",
p.adjust.method.D = "fdr", nrepet = 999)

four.comb.ants.adj 
plot(four.comb.ants.adj, alpha = 0.05, stat = "D2")
#why are the p adj so different for a bivariate correlation? 
#not sure


fit <- traitglm(spe.bin, env4, traits.spe,family = "binomial")
#summary(fit)
fit$fourth #notice LASSO penalty has shrunk many interactions to zero

a        = max( abs(fit$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
plot.4th = levelplot(t(as.matrix(fit$fourth.corner)), xlab="Environmental Variables",
 ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
 scales = list( x= list(rot = 45)))
print(plot.4th)



```


## Functional diversity



```{r}


library(FD)

#need a species by trait matrix, but I want to use the population means
#make species name the name + site

trait.pop <- traits.ag
trait.pop$spepop <- paste(trait.pop$species, trait.pop$Site)
trait.pop <- ungroup(trait.pop) %>% select(spepop, Trait, mean)
trait.pop <- pivot_wider(trait.pop, names_from = Trait, values_from = mean)
trait.pop <- select(trait.pop, 1, 3, 5, 7, 8, 11, 13, 14)

# need a species by site matrix with the species pop names

long.pop <- long.pres
long.pop$spepop <- paste(long.pop$species, long.pop$Site)
long.pop <- select(long.pop, 1, 8, 5)



wide.pop <- pivot_wider(long.pop, names_from = spepop, values_from = count.bin)
wide.pop[is.na(wide.pop)] <- 0
sites <- wide.pop$uniID

wide.pop <- ungroup(wide.pop) %>% select(-uniID)
wide.pop <- wide.pop[which(colSums(wide.pop) !=0)]
wide.pop <- cbind(sites, wide.pop)
row.names(wide.pop) <- wide.pop$sites
wide.pop <- select(wide.pop, -sites)

wide.pop <- wide.pop[which(rowSums(wide.pop) !=0),]


#check to ensure names are matched correctly between dataframes
spec <- colnames(wide.pop)
all.equal(spec, trait.pop$spepop)
trait.pop <- as.data.frame(trait.pop)
row.names(trait.pop) <- trait.pop$spepop
trait.pop <- select(trait.pop, -spepop)
fun <- dbFD(trait.pop, wide.pop)

```

# Sorenson

However, in this study we used
the C-score to evaluate co-occurrence between each pair
of species as C-score = (a âˆ’ c) (b âˆ’ c), where a is the total
number of occurrences of one species, b is the total number
of occurrences of a second species, and c is the number of
sites that contain both species




Contrarily, the SÃ¸rensen index
(Dice 1945) measures the mean number of shared sites (i.e.,
grid cells in our study) between a species pair, calculated
as Sðœ™r = 2câˆ•(2c + a + b), where a, b and c are defined as
above. 




# Ant-habitat associations
## Indicator species analysis

- microsite
- shrub type at site
- study site

# Beta-diversity

```{r}
library(betapart)

spe.bin.core <- betapart.core(spe.bin)
spe.bin.multi <- beta.multi(spe.bin)
spe.bin.samp <- beta.sample(spe.bin.core, sites = 9, samples = 100)


dist <- beta.pair(spe.bin, index.family = "sorensen")

bd <- vegan::betadisper(dist[[3]], env4$shrub.site)

boxplot(bd)
anova(bd)
# difference in dispersion between the three
TukeyHSD(bd)
# contrasts not significant. ok.

library(FD)
library(vegan)
gow <- gowdis(env4)
euc <- dist(env4, "euclidean")
gow <- as.matrix(gow)
sor <- dist[[3]]
sor <- as.matrix(sor)

sor.mean <- rowMeans(sor, na.rm = TRUE)
sim <- as.matrix(dist[[1]])
sim.mean <- rowMeans(sim, na.rm = TRUE)
sne <- as.matrix(dist[[2]])
sne.mean <- rowMeans(sne, na.rm = TRUE)

envbeta <- cbind(env4, sor.mean, sim.mean, sne.mean)


mb <- glmmTMB(sim.mean ~  arid  + esi + mean.cover +dry.veg.percent+  Microsite  + shrub.site + (1|Site), data = envbeta)
shapiro.test(resid(msor))
plot(resid(mb))
summary(mb)
check_collinearity(mb)

ggplot(envbeta, aes(arid, sor.mean)) + geom_smooth() 


msor <- glmmTMB(sor.mean ~  arid  + esi + mean.cover +dry.veg.percent+  Microsite  + shrub.site + (1|Site), data = envbeta)
summary(msor)
msor2 <- glmmTMB(sor.mean ~  arid  + esi + mean.cover +dry.veg.percent+  Microsite  + shrub.site , data = envbeta)

summary(msor2)

AIC(msor, msor2)

plot(resid(mb) ~ envbeta$sim.mean)
mb2 <- glmmTMB(sne.mean ~  arid   +mean.cover +dry.veg.percent+  Microsite  + shrub.site +(1|Site), data = envbeta)

size <- filter(CWM.pres, Trait == "Webers")
m1 <- glmmTMB(cwm ~ esi + (1|Site.x), data = size)
summary(m1)

m2 <- glmmTMB(cwm ~ arid + (1|Site.x), data = size)
summary(m2)

ggplot(size, aes(arid, cwm)) + geom_smooth(method = lm)


summary(mb)
summary(mb2)


envlong <- pivot_longer(envbeta, 11:13, names_to = "beta", values_to = "mean")

envlong <- pivot_longer(envlong, c(1:6, 8, 9), names_to = "env", values_to = "value")

ggplot(envlong, aes(value,mean , color = beta)) +
  stat_smooth(method = "lm") + facet_wrap(~env, scales = "free")



euc.dry <-dist(env4$dry.veg.percent, "euclidean")
euc.Prec <- dist(env4$Prec, "euclidean")
euc.esi <- dist(env4$esi, "euclidean")
euc.vegheight <- dist(env4$veg..height, "euclidean")
euc.temp <- dist(env4$Temp, "euclidean")
euc.siteveg <- dist(env4$mean.bare, "euclidean")
euc.arid <- dist(env4$arid, "euclidean")

mantel(euc.dry, sor, method = "spearman", permutations = 999, na.rm = TRUE)


mantel(euc.Prec, sor, method = "spearman", permutations = 99, na.rm = TRUE)

mantel(euc.Prec, gow, method = "spearman", permutations = 99, na.rm = TRUE)

mantel(euc.vegheight, sor, method = "spearman", permutations = 99, na.rm = TRUE)

mantel(euc.temp, sor, method = "spearman", permutations = 99, na.rm = TRUE)

mantel(euc.siteveg, sor, method = "spearman", permutations = 99, na.rm = TRUE)

mantel(euc.arid, sor, method = "spearman", permutations = 99, na.rm = TRUE)
mantel(euc.esi, sor, method = "spearman", permutations = 99, na.rm = TRUE)

n <- mantel(euc.arid, sim, method = "spearman", permutations = 99, na.rm = TRUE)
mantel(euc.esi, sim, method = "spearman", permutations = 99, na.rm = TRUE)

plot(n)

# dry.veg. percent matters
# site level differences do

#yes, beta diversity (species composition) is correlated with the environment
```
# Co-occurence

Make dist dataframes for pairwise C-scores at site and pitfall trap level
```{r}

pitlabels <- select(wide, 1 ,2)
pitwide <- wide
pitwide <- select(pitwide, -1, -2)
#make dataframe presence/absence
pitwide[pitwide > 1] <- 1
#calculate pairwise C-Scores
pitc <- designdist(t(pitwide), "(A-J)*(B-J)", "binary")
pitc <- as.matrix(pitc)

#let's try with a package
library(ecospat)
library(bipartite)

c <- C.score(pitwide, normalise = TRUE, FUN = hist)
C.score(pitwide, normalise = TRUE, FUN = print)
?C.score

library(eco)

```


# Models
## Ant abundance

```{r}
cov %>% group_by(month) %>% summarise(sum = sum(abun))


m1.m11 <- glmmTMB(abun ~ dry.veg.percent + Microsite + month + mean.cover + Prec + (1|Site), family = "poisson", data = cov)
summary(m1.m11)
check_overdispersion(m1.m11)

m1.mnb <- glmmTMB(abun ~ dry.veg.percent + Microsite + month + mean.cover + arid + esi + shrub.site + (1|Site), family = "nbinom2", data = cov)
summary(m1.mnb)


v1 <- glmmTMB(dry.veg.percent ~ Microsite + month +  arid * shrub.site + (1|Site), family = "nbinom2", data = cov)
summary(v1)


ggplot(cov, aes(arid, dry.veg.percent)) + geom_smooth()

```

## Ant richness

```{r}
m1 <- glmmTMB(Species ~ arid +mean.cover +dry.veg.percent + Microsite  + shrub.site + month + (1|Site) , family = "poisson", data = cov)
m2 <- glmmTMB(Species ~ arid dry.veg.percent + var.cover +Microsite  + shrub.site + month + (1|Site) , family = "poisson", data = cov)
m3 <- glmmTMB(Species ~ arid +mean.cover +dry.veg.percent + var.cover +Microsite  + shrub.site + month + esi + (1|Site) , family = "poisson", data = cov)
m4 <- glmmTMB(Species ~ arid +mean.cover +dry.veg.percent  +Microsite  + shrub.site + month + esi + (1|Site) , family = "poisson", data = cov)



m5 <- glmmTMB(Species ~ mean.cover +dry.veg.percent  +Microsite  + shrub.site +  esi + arid + (1|Site) , family = "poisson", data = cov)
summary(m5)
AIC(m1,m2, m3, m4, m5)

ggplot(cov, aes(arid, Species)) + geom_smooth()



cor.test(cov$mean.cover, cov$var.cover)

summary(m2)
library(performance)

check_collinearity(m5)
m2 <- glmmTMB(Species ~ dry.veg.percent + Microsite  + mean.cover +  esi + mean.height +  shrub.site + arid + month + (1|Site) , family = "nbinom2", data = cov)
summary(m2)

AIC(m1, m2)
```

## ITV Plots

```{r}

itv <- read.csv("raw data/itv.csv")
itv <- itv %>% mutate(total = Species + ITV) %>% mutate(sp.rel = Species/total, itv.rel = ITV/total)

itv = pivot_longer(itv, 5:6, names_to = "rel.itv", values_to = "val")

itv$Trait <- factor(itv$Trait, levels = unique(itv$Trait[order(itv$val)]))

ggplot(itv, aes(Trait, val, fill = rel.itv)) +geom_bar(position="stack", stat = "identity", aes(fill = rel.itv)) + ylab("Proportion variation explained by species") +
  theme(legend.position="none") + scale_fill_manual(values = c("gray", "black")) + theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))


```

ggplot(veg, aes(Microsite, dry.veg.percent)) + geom_violin() + geom_boxplot(width = 0.05) + theme(axis.text.x=element_text(angle=90, vjust=.5)) + ylab("Percent Cover Vegetation") + xlab("")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
var <- dplyr::select(ants,1, 11:15, 17)
row.names(var) <- var$X
var <- dplyr::select(var, -X)
var$veg..height[is.na(var$veg..height)] <- 0


cov <- dplyr::select(ants, 1, 2, 3, 5)


pca1<- prcomp(var)
summary(pca1)
pca1

library(ggfortify)
autoplot(pca1, data = cov, colour = "Microsite", loadings = TRUE, loadings.label = TRUE)








## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
